name: Hugo CI/CD - Multi-Author Blog

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly security scan at 2 AM UTC on Sundays
    - cron: '0 2 * * 0'

env:
  HUGO_VERSION: '0.126.0'
  NODE_VERSION: '20'

jobs:
  validate:
    name: ğŸ” Validate Content & Security
    runs-on: ubuntu-latest
    outputs:
      authors-changed: ${{ steps.changes.outputs.authors }}
      posts-changed: ${{ steps.changes.outputs.posts }}
      config-changed: ${{ steps.changes.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            authors:
              - 'data/authors.json'
            posts:
              - 'content/posts/**'
            config:
              - 'hugo.toml'
              - 'package.json'
              - 'tsconfig.json'
              - '.github/workflows/**'
            components:
              - 'assets/js/**'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          echo "ğŸ“¦ Dependencies installed successfully"

      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level moderate
          echo "âœ… Security audit completed"

      - name: ğŸ“ Lint Markdown
        run: |
          echo "ğŸ“ Linting markdown files..."
          find content -name "*.md" -type f | head -10 | while read file; do
            echo "Checking: $file"
            # Basic markdown validation
            if ! grep -q "^---" "$file"; then
              echo "âš ï¸  Missing front matter in $file"
            else
              echo "âœ… $file has front matter"
            fi
          done

      - name: âœ… Validate Author Data
        run: |
          echo "ğŸ” Validating author data structure..."
          node -e "
            const fs = require('fs');

            if (!fs.existsSync('data/authors.json')) {
              console.log('âš ï¸  Authors file not found, skipping validation');
              process.exit(0);
            }

            const authors = JSON.parse(fs.readFileSync('data/authors.json', 'utf8'));

            if (!authors || typeof authors !== 'object') {
              throw new Error('Authors data must be a valid object');
            }

            Object.entries(authors).forEach(([id, author]) => {
              const required = ['name', 'bio', 'avatar'];
              required.forEach(field => {
                if (!author[field]) {
                  throw new Error(\`Author \${id} missing required field: \${field}\`);
                }
              });

              if (author.avatar && !author.avatar.startsWith('http')) {
                console.warn(\`Warning: Author \${author.name} avatar should be a full URL\`);
              }

              if (author.bio && author.bio.length > 250) {
                console.warn(\`Warning: Author \${author.name} bio is longer than 250 characters\`);
              }
            });

            console.log('âœ… Author data validation passed');
          "

      - name: ğŸ·ï¸ Validate Post Front Matter
        run: |
          echo "ğŸ” Validating post front matter..."

          if [ ! -d "content/posts" ]; then
            echo "âš ï¸  No posts directory found, skipping validation"
            exit 0
          fi

          find content/posts -name "*.md" -type f | while read file; do
            echo "Checking: $file"

            # Check if file has front matter
            if ! grep -q "^---" "$file"; then
              echo "âŒ Missing front matter in $file"
              exit 1
            fi

            # Check for required fields
            if ! grep -q "^title:" "$file"; then
              echo "âŒ Missing title in $file"
              exit 1
            fi

            if ! grep -q "^date:" "$file"; then
              echo "âŒ Missing date in $file"
              exit 1
            fi

            echo "âœ… $file validated"
          done

      - name: ğŸ”§ Lint TypeScript/JavaScript
        run: |
          echo "ğŸ”§ Linting TypeScript and JavaScript files..."
          npm run lint
          echo "âœ… Code linting completed"

      - name: ğŸ¨ Check Code Formatting
        run: |
          echo "ğŸ¨ Checking code formatting..."
          npm run format:check
          echo "âœ… Code formatting check completed"

  test:
    name: ğŸ§ª Run Tests
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          echo "ğŸ“¦ Dependencies installed for testing"

      - name: ğŸ”¬ Run Unit Tests
        run: |
          echo "ğŸ”¬ Running unit tests..."
          npm run test:coverage
          echo "âœ… Unit tests completed"

      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v4
        if: success()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: ğŸ­ Install Playwright Browsers
        run: |
          echo "ğŸ­ Installing Playwright browsers..."
          npx playwright install --with-deps chromium
          echo "âœ… Playwright browsers installed"

      - name: ğŸ­ Run E2E Tests
        run: |
          echo "ğŸ­ Running end-to-end tests..."
          # Build first for E2E tests
          npm run build
          # Start Hugo server in background for E2E tests
          hugo server --port 1314 --bind 127.0.0.1 &
          SERVER_PID=$!

          # Wait for server to be ready
          sleep 5

          # Run E2E tests
          npm run test:e2e -- --reporter=html

          # Kill Hugo server
          kill $SERVER_PID || true

          echo "âœ… E2E tests completed"

      - name: ğŸ“¤ Upload E2E Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  build:
    name: ğŸ—ï¸ Build Site
    needs: [validate, test]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          echo "ğŸ“¦ Dependencies installed for build"

      - name: âš›ï¸ Build React Components
        run: |
          echo "ğŸ”¨ Building React components..."
          npm run build
          echo "âœ… React build completed"

          # Verify build output
          if [ -f "static/js/main.js" ]; then
            echo "âœ… Main JavaScript bundle created"
            ls -la static/js/
          else
            echo "âŒ Main JavaScript bundle not found"
            exit 1
          fi

      - name: ğŸ¦„ Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: ğŸš€ Build Hugo Site
        run: |
          echo "ğŸ”¨ Building Hugo site..."
          hugo --minify --gc --verbose
          echo "âœ… Hugo build completed"

          # Verify Hugo build
          if [ -f "public/index.html" ]; then
            echo "âœ… Hugo site generated successfully"
          else
            echo "âŒ Hugo site generation failed"
            exit 1
          fi

      - name: ğŸ” Check Build Quality
        run: |
          echo "ğŸ” Checking build quality..."

          # Check for broken internal links
          echo "Checking internal links..."
          find public -name "*.html" -exec grep -l "href=\"/" {} \; | head -5 | while read file; do
            echo "Checking links in $(basename $file)"
            # Basic link validation
            grep -o 'href="[^"]*"' "$file" | grep -o '/[^"]*' | head -5 | while read link; do
              if [ -f "public$link" ] || [ -f "public${link}index.html" ] || [ -d "public$link" ]; then
                echo "âœ… $link"
              else
                echo "âš ï¸  Potential broken link: $link"
              fi
            done
          done

          # Check bundle sizes
          echo "Bundle size analysis:"
          find static/js -name "*.js" | while read file; do
            size=$(wc -c < "$file")
            echo "$(basename $file): ${size} bytes"
            if [ $size -gt 1048576 ]; then  # 1MB
              echo "âš ï¸  Large bundle detected: $(basename $file)"
            fi
          done

      - name: ğŸ“Š Generate Build Report
        run: |
          echo "ğŸ“Š Build Report" > build-report.txt
          echo "===============" >> build-report.txt
          echo "Build Date: $(date)" >> build-report.txt
          echo "Commit: ${{ github.sha }}" >> build-report.txt
          echo "Hugo Version: ${{ env.HUGO_VERSION }}" >> build-report.txt
          echo "Node Version: ${{ env.NODE_VERSION }}" >> build-report.txt
          echo "" >> build-report.txt

          echo "ğŸ“„ Pages Generated:" >> build-report.txt
          find public -name "*.html" | wc -l >> build-report.txt

          echo "" >> build-report.txt
          echo "ğŸ“ JavaScript Assets:" >> build-report.txt
          find public -name "*.js" | wc -l >> build-report.txt

          echo "" >> build-report.txt
          echo "ğŸ“ CSS Assets:" >> build-report.txt
          find public -name "*.css" | wc -l >> build-report.txt

          echo "" >> build-report.txt
          echo "ğŸ“¦ Total Site Size:" >> build-report.txt
          du -sh public/ | cut -f1 >> build-report.txt

          echo "" >> build-report.txt
          echo "ğŸ”— Sample URLs Generated:" >> build-report.txt
          find public -name "index.html" | head -5 | sed 's|public||g' >> build-report.txt

      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-site
          path: public
          retention-days: 7

      - name: ğŸ“¤ Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.txt
          retention-days: 30

  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    needs: [validate, test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: hugo-site
          path: public

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Verify Deployment
        run: |
          echo "ğŸŒ Site deployed to: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ‰ Deployment completed successfully!"

  notify:
    name: ğŸ“¬ Send Notifications
    needs: [validate, test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“Š Create Job Summary
        run: |
          echo "# ğŸš€ Tech.ish Thoughts - Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Job Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Validation | ${{ needs.validate.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Testing | ${{ needs.test.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Build | ${{ needs.build.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deploy | ${{ needs.deploy.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "## ğŸ”— Important Links" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ [Live Site](https://techishthoughts.github.io)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š [Build Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ˆ [Performance Report](https://pagespeed.web.dev/analysis/https-techishthoughts-github-io/)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”„ Change Details" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“ Commit**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ‘¤ Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“… Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.head_commit.message }}" != "" ]; then
            echo "**ğŸ’¬ Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Hugo Version**: ${{ env.HUGO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on Pull Request
        if: github.event_name == 'pull_request' && needs.build.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ğŸš€ Build Status')
            );

            const buildStatus = {
              validate: '${{ needs.validate.result }}',
              test: '${{ needs.test.result }}',
              build: '${{ needs.build.result }}'
            };

            const statusEmoji = {
              success: 'âœ…',
              failure: 'âŒ',
              cancelled: 'â¹ï¸',
              skipped: 'â­ï¸'
            };

            const commentBody = \`
            ## ğŸš€ Build Status - Tech.ish Thoughts

            | Stage | Status | Result |
            |-------|--------|--------|
            | ğŸ” Validation | \${statusEmoji[buildStatus.validate] || 'â“'} | \${buildStatus.validate} |
            | ğŸ§ª Testing | \${statusEmoji[buildStatus.test] || 'â“'} | \${buildStatus.test} |
            | ğŸ—ï¸ Build | \${statusEmoji[buildStatus.build] || 'â“'} | \${buildStatus.build} |

            ### ğŸ“Š Summary
            \${buildStatus.build === 'success' ?
              'âœ… **Your changes have been successfully built and validated!**' :
              'âŒ **Build failed. Please check the logs for details.**'
            }

            ### ğŸ”„ Next Steps
            \${buildStatus.build === 'success' ?
              \`- ğŸ‘€ Review the changes carefully
              - ğŸ§ª All tests are passing
              - ğŸš€ Ready to merge when approved\` :
              \`- ğŸ” Check the build logs for error details
              - ğŸ› ï¸ Fix any issues and push updates
              - ğŸ”„ The build will run automatically on new commits\`
            }

            ### ğŸ“ˆ Artifacts
            - ğŸ“Š [Build Report](https://github.com/\${context.repo.owner}/\${context.repo.repo}/actions/runs/\${context.runId})
            - ğŸ§ª [Test Results](https://github.com/\${context.repo.owner}/\${context.repo.repo}/actions/runs/\${context.runId})

            ---
            *This comment is automatically updated on each commit.*
            \`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: ğŸ“§ Notify on Success
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ Site is live at: https://techishthoughts.github.io"
          echo "ğŸ“Š Build completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— View build details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ğŸ“§ Notify on Failure
        if: failure()
        run: |
          echo "âŒ Build or deployment failed!"
          echo "ğŸ” Check the logs for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ› ï¸  Common troubleshooting steps:"
          echo "  1. Verify all markdown files have proper front matter"
          echo "  2. Check author data structure in data/authors.json"
          echo "  3. Ensure all required fields are present in posts"
          echo "  4. Verify TypeScript compilation errors"
          echo "  5. Check for broken internal links"
          echo ""
          echo "ğŸ“š For help, visit: https://github.com/${{ github.repository }}/issues"
